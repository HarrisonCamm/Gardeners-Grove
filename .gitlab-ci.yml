stages:
  - tagChecking
  - build
  - test
  - sonarqube
  - deploy

tag-checker:
  stage: tagChecking
  script:
    - python3 tag_checker.py $CI_COMMIT_TAG
  only:
    - tags

junit:
  stage: test
  script:
    - ./gradlew check
    - ls ./build/jacoco
  artifacts:
    paths:
      - build/jacoco/test-report.xml
    # TODO: when configuring SonarQube to show code coverage in tests, you will need to add some lines here
    # that keep the coverage report files generated by this job so that they can be uploaded to SonarQube

sonarqube-report:
  stage: sonarqube
  script:
    ./gradlew sonarqube    

# builds all branches, except dev and main
branch-build:
  stage: build
  script:
    - ./gradlew bootJar
  artifacts:
    paths:
      - build/libs
  except:
    - tags
    - main
    - development

deploy-staging:
  stage: deploy
  script:
    - ./gradlew bootJar
    - rm -rf /home/gitlab-runner/staging/ || true
    - mkdir /home/gitlab-runner/staging/
    - cp -r ./build/libs /home/gitlab-runner/staging
    - cp runner-scripts/staging.sh /home/gitlab-runner/staging.sh
    - chmod u+x /home/gitlab-runner/staging.sh
    - echo "export AZURE_API_KEY=${AZURE_API_KEY}" >> /home/gitlab-runner/staging/.env
    - echo "export AZURE_API_URL=${AZURE_API_URL}" >> /home/gitlab-runner/staging/.env
    - echo "export SONARQUBE_TOKEN=${SONARQUBE_TOKEN}" > /home/gitlab-runner/staging/.env
    - echo "export WEATHER_API_KEY=${WEATHER_API_KEY}" >> /home/gitlab-runner/staging/.env
    - echo "export WEATHER_API_URL=${WEATHER_API_URL}" >> /home/gitlab-runner/staging/.env
    - echo "export GEOAPIFY_API_KEY=${GEOAPIFY_API_KEY}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL_TEST}" >> /home/gitlab-runner/staging/.env
    - echo "export GARDENERSGROVE_DEPLOYMENT=${GARDENERSGROVE_DEPLOYMENT_TEST}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME_DEPLOY}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD_DEPLOY}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_JPA_DATABASE_PLATFORM=${SPRING_JPA_DATABASE_PLATFORM_DEPLOY}" >> /home/gitlab-runner/staging/.env
    - echo "export SPRING_DATASOURCE_DRIVERCLASSNAME=${SPRING_DATASOURCE_DRIVERCLASSNAME_DEPLOY}" >> /home/gitlab-runner/staging/.env
    - sudo systemctl restart staging
  artifacts:
    paths:
      - build/libs
  only:
    - development

deploy-production:
  stage: deploy
  script:
    - ./gradlew bootJar
    - rm -rf /home/gitlab-runner/production/ || true
    - mkdir /home/gitlab-runner/production/
    - cp -r ./build/libs /home/gitlab-runner/production
    - cp runner-scripts/production.sh /home/gitlab-runner/production.sh
    - chmod u+x /home/gitlab-runner/production.sh
    - echo "export AZURE_API_KEY=${AZURE_API_KEY}" >> /home/gitlab-runner/production/.env
    - echo "export AZURE_API_URL=${AZURE_API_URL}" >> /home/gitlab-runner/production/.env
    - echo "export SONARQUBE_TOKEN=${SONARQUBE_TOKEN}" > /home/gitlab-runner/production/.env
    - echo "export WEATHER_API_KEY=${WEATHER_API_KEY}" >> /home/gitlab-runner/production/.env
    - echo "export WEATHER_API_URL=${WEATHER_API_URL}" >> /home/gitlab-runner/production/.env
    - echo "export GEOAPIFY_API_KEY=${GEOAPIFY_API_KEY}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL_PROD}" >> /home/gitlab-runner/production/.env
    - echo "export GARDENERSGROVE_DEPLOYMENT=${GARDENERSGROVE_DEPLOYMENT_PROD}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME_DEPLOY}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD_DEPLOY}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_JPA_DATABASE_PLATFORM=${SPRING_JPA_DATABASE_PLATFORM_DEPLOY}" >> /home/gitlab-runner/production/.env
    - echo "export SPRING_DATASOURCE_DRIVERCLASSNAME=${SPRING_DATASOURCE_DRIVERCLASSNAME_DEPLOY}" >> /home/gitlab-runner/production/.env
    - sudo systemctl restart production
  artifacts:
    paths:
      - build/libs
  only:
    - tags

