<!DOCTYPE html>
<html lang="en">
    <!-- Head fragment holding all the style sheets-->
    <head th:replace="fragments/head :: head(title='View Garden')"> </head>
    <body>
        <!-- NavBar Fragment -->
        <ul th:insert="~{fragments/navBar.html :: navBar}"></ul>

        <div class="wrapper">
            <!-- SideNav Fragment -->
            <div th:insert="~{fragments/sideBar.html :: sideBar}"></div>

            <!-- View Garden Page Content -->
            <div class="gardenContainer">
                <div class="gardenDetails container">
                    <div class="row mb-3">
                        <div class="col">
                            <h3 th:text="${gardenName}">  </h3>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <h3 th:text="${gardenLocation}">  </h3>
                        </div>
                    </div>
                    <div class="row mb-3" th:classappend="${gardenSize == '' ? 'disabled' : ''}">
                        <div class="col">
                            <h3 th:utext="${gardenSize} + ' m<sup>2</sup>'"></h3>
                        </div>
                    </div>

                    <!-- Weather Section -->
                    <div class="row p-3">
                        <div class="col">
                            <div class="container bg-info bg-gradient shadow rounded-4 p-4 z-3 position-relative">
                                <div th:if="${weatherResponse != null}">

                                    <h3><strong> <span th:text="${weatherResponse.dayOfWeek}"></span></strong></h3>
                                    <p><strong>Date:</strong> <span th:text="${weatherResponse.date}"></span></p>
                                    <p><strong>Description:</strong> <span th:text="${weatherResponse.description}"></span></p>
                                    <p><strong>Temperature:</strong> <span th:text="${weatherResponse.temperature}"></span>&#8451;</p>
                                    <p><strong>Humidity:</strong> <span th:text="${weatherResponse.humidity}"></span>%</p>

                                    <div class="z-2 position-absolute top-0 end-0">
                                        <img th:src="@{'http://openweathermap.org/img/wn/' + ${weatherResponse.icon} + '@2x.png'}" class="img-fluid w-200" alt="Weather Icon" />
                                    </div>
                                </div>
                                <div th:if="${weatherResponse == null}" class="error-message">
                                    <p>Location not found, please update your location to see the weather</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3" th:if="${gardenTags != null and gardenTags.size() > 0}">
                        <div class="col d-flex flex-wrap">
                            <th:block th:each="tag : ${gardenTags}">
                                <span class="badge me-2 mb-2 tag-colour" th:text="${#strings.abbreviate(tag.name,20)}"></span>
                            </th:block>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <div id="imageError" class="error-message"></div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="d-flex justify-content-end">
                        <a th:href="@{'/edit-garden?gardenID=' + ${gardenID}}" class="btn btn-primary button">
                            Edit
                        </a>
                    </div>
                    <div class="d-flex justify-content-end">
                        <a th:href="@{'/create-plant?gardenID=' + ${gardenID}}" class="btn btn-primary button">
                            Add new plant
                        </a>
                    </div>
                    <div class="col d-flex justify-content-end pt-1">
                        <form class="tags" id="tagForm" th:action="@{/add-tag(gardenID=${gardenID})}" method="post">
                            <div class="d-flex w-300">
                                <div class="input-group">
                                    <input type="text" class="tag-input w-350 p-1 rounded-start" placeholder="Enter tag" id="tagInput" name="tag" th:value="${tagInput}">
                                    <button class="tag-input tag-x p-1 rounded-end text-black border-0" type="button" id="clearButton">x</button>
                                </div>
                                <button class="btn btn-primary button ms-2" type="submit" id="addTagButton">+</button>
                                <div class="container mt-3" id="autocompleteList"></div>
                            </div>
                        </form>
                    </div>

                </div>
                <div class="plantContainer table-responsive bg-light" style="max-height: calc(97px * 6); overflow-y: auto;">
                    <table class="table">
                        <thead>
                        <tr class="garden-table">
                            <th>Picture &nbsp;</th>
                            <th>Plant Name &nbsp;</th>
                            <th>Count &nbsp;</th>
                            <th>Description &nbsp;</th>
                            <th>Date Planted</th>
                            <th>Edit Plant</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr th:each="plant : ${plants}" class="plant-row">
                                <td>
                                    <div class="image-icon-div-small">
                                        <div class="image-upload">
                                            <img class="image-small"
                                                 th:id="${plant.id}" th:data-plant-id="${plant.id}"
                                                 th:src="@{/get-image?view-garden=true(plantID=${plant.id})}" alt="">
                                            <input th:value="imagePath" class="file-input" type="file" name="file" id="file">
                                            <button class="image-picker-small" th:image-button-id="${plant.id}">+</button>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${#strings.abbreviate(plant.name, 30)}"></td>
                                <td th:text="${plant.count}"></td>
                                <td th:text="${plant.description}" class="text-wrap"></td>
                                <td th:text="${plant.datePlanted}"></td>
                                <td>
                                    <a th:href="@{'/edit-plant?plantID=' + ${plant.id}}">
                                        <button type="button" class="btn btn-primary button">Edit</button>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Scripts fragment, contains bootstrap scripts -->
        <div th:replace="~{fragments/scripts :: scripts}"></div>
    </body>
</html>

<script th:inline="javascript">
    window.addEventListener('DOMContentLoaded', () => {
        const allTags = [[${allTags}]];
        const plantContainer = document.querySelector('.plantContainer');
        const gardenDetails = document.querySelector('.gardenDetails');
        const clearButton = document.getElementById('clearButton');
        const tagInput = document.getElementById('tagInput');
        const autocompleteList = document.getElementById('autocompleteList');

        function adjustWidth() {
            const width = plantContainer.offsetWidth;
            gardenDetails.style.width = `${width}px`;
        }

        // Adjust width of gardenDetails initially
        adjustWidth();

        // Adjust width of gardenDetails when window is resized
        window.addEventListener('resize', adjustWidth);

        clearButton.addEventListener('click', () => {
            tagInput.value = '';
        });

        tagInput.addEventListener('keydown', (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById('tagForm').submit();
            }
        });

        // This code is AI generated :)
        tagInput.addEventListener('input', function() {
            // Get the current input
            let input = this.value;

            // Clear the autocomplete list
            autocompleteList.innerHTML = '';

            // Only proceed if the input is not empty
            if (input.trim() !== '') {
                // Filter the tags
                let suggestions = allTags.filter(function(tag) {
                    return tag.name.toLowerCase().startsWith(input.toLowerCase());
                });

                // Create an autocomplete item for each suggestion
                suggestions.forEach(function(tag, index) {
                    let item = document.createElement('button');
                    item.className = 'dropdown-item autocomplete-tag-item'; // Bootstrap class
                    //Abbreviate the tag name if it is too long to fit within a reasonable width (20 characters)
                    item.textContent = tag.name.length > 20 ? tag.name.substring(0, 20) + '...' : tag.name;
                    item.addEventListener('click', function() {
                        // Set the input value to the clicked item's text
                        tagInput.value = this.textContent;

                        // Clear the autocomplete list
                        autocompleteList.innerHTML = '';
                        autocompleteList.style.display = 'none'; // Hide the list

                        // Submit the form
                        document.getElementById('tagForm').submit();
                    });
                    autocompleteList.appendChild(item);

                    // Add a horizontal line after each item, except the last one
                    if (index !== suggestions.length - 1) {
                        let hr = document.createElement('hr');
                        autocompleteList.appendChild(hr);
                    }
                });

                if (suggestions.length > 0) {
                    console.log(suggestions);
                    autocompleteList.style.display = 'block'; // Show the list
                } else {
                    autocompleteList.style.display = 'none'; // Hide the list if no suggestions
                }
            } else {
                autocompleteList.style.display = 'none'; // Hide the list if input is empty
            }
        });
    });
</script>
